```test
# name: test/sql/pac_compiler.test
# description: basic pac_compiler smoke tests (dummy outputs)
# group: [sql]

require pac

statement ok
PRAGMA remove_pac_privacy_unit('t_single');
statement ok
PRAGMA remove_pac_privacy_unit('t_left');
statement ok
PRAGMA remove_pac_privacy_unit('t_right');

-- Ensure a clean slate: drop tables once at the beginning of the test file
statement ok
DROP TABLE IF EXISTS t_single;
statement ok
DROP TABLE IF EXISTS t_left;
statement ok
DROP TABLE IF EXISTS t_right;

# Test 1: single table with GROUP BY
statement ok
-- create and populate table (no conditional inserts; we dropped above so this is deterministic)
statement ok
CREATE TABLE t_single(group_key VARCHAR, val DOUBLE, cnt INTEGER);
statement ok
INSERT INTO t_single VALUES ('A', 10.0, 3), ('A', 11.0, 3), ('B', 20.0, 3);

# Register as protected table (compiler path that expects a privacy unit)
statement ok
PRAGMA add_pac_privacy_unit('t_single');

query I
SELECT group_key, SUM(val) AS sum_val, SUM(cnt) AS sum_cnt
FROM t_single
GROUP BY group_key
ORDER BY group_key;
----
DUMMY

statement ok
PRAGMA remove_pac_privacy_unit('t_single');

# Test 2: two tables JOIN + GROUP BY
statement ok
-- create and populate tables (no mid-test drops/deletes)
statement ok
CREATE TABLE t_left(id INTEGER, group_key VARCHAR, val DOUBLE, cnt INTEGER);
statement ok
CREATE TABLE t_right(id INTEGER, attr VARCHAR);
statement ok
INSERT INTO t_left VALUES (1,'A',10.0,3),(2,'B',20.0,3);
statement ok
INSERT INTO t_right VALUES (1,'x'),(2,'y');

# Register left table as protected
statement ok
PRAGMA add_pac_privacy_unit('t_left');

query I
SELECT l.group_key, SUM(l.val) AS sum_val, SUM(l.cnt) AS sum_cnt
FROM t_left l
JOIN t_right r ON l.id = r.id
GROUP BY l.group_key
ORDER BY l.group_key;
----
DUMMY

statement ok
PRAGMA remove_pac_privacy_unit('t_left');

# Test 3: join + filter + group by
statement ok
-- reuse existing t_left and t_right from Test 2: do NOT delete or recreate data; run a normal query
statement ok
PRAGMA add_pac_privacy_unit('t_left');

query I
SELECT l.group_key, SUM(l.val) AS sum_val, COUNT(*) AS cnt_rows
FROM t_left l
JOIN t_right r ON l.id = r.id
WHERE r.attr = 'x'
GROUP BY l.group_key
ORDER BY l.group_key;
----
DUMMY

statement ok
PRAGMA remove_pac_privacy_unit('t_left');
```
